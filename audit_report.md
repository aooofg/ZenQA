# Аудит проекта TMS (Test Management System)

## Общая оценка

Проект демонстрирует хорошую архитектуру, современный стек технологий (Svelte 5, PocketBase, Tailwind CSS) и продуманную структуру. Код в целом соответствует best practices, но есть ряд потенциальных проблем и областей для улучшения.

---

## 1. Архитектурные проблемы

### 1.1. Отсутствие типизации TypeScript в ключевых компонентах
**Проблема:** Во многих компонентах используется `any` для типов данных (например, `caseData: any` в `CaseEditor.svelte`), что снижает надежность и усложняет рефакторинг.

**Рекомендация:**
- Создать интерфейсы/типы для сущностей БД (`Case`, `Suite`, `Project`, `Run` и т.д.)
- Экспортировать типы из `$lib/types.ts` и использовать их во всех компонентах
- Включить строгие проверки TypeScript в `tsconfig.json`

### 1.2. Прямые вызовы PocketBase API в компонентах
**Проблема:** Логика работы с данными размазана по компонентам, что усложняет тестирование и повторное использование.

**Рекомендация:**
- Создать слой репозиториев/сервисов для инкапсуляции операций с БД
- Вынести общие запросы в отдельные модули (`caseService.ts`, `suiteService.ts`)
- Реализовать кэширование часто запрашиваемых данных

### 1.3. Отсутствие централизованной обработки ошибок
**Проблема:** Ошибки обрабатываются через `console.error` и `alert`, нет единого механизма логирования и уведомления пользователя.

**Рекомендация:**
- Создать сервис уведомлений/тостов с поддержкой разных типов сообщений
- Реализовать перехватчик ошибок для PocketBase запросов
- Добавить логирование ошибок на сервер для production

---

## 2. Проблемы безопасности

### 2.1. Уязвимые значения по умолчанию в `.env`
**Проблема:** В `.env` используются слабые пароли и ключи шифрования (`secure_password_123`, `super_secret_dev_key_change_me`).

**Рекомендация:**
- Обязать использование сильных паролей при деплое
- Добавить валидацию переменных окружения при запуске
- Использовать генерацию случайных значений для `PB_ENCRYPTION_KEY`

### 2.2. Отсутствие защиты от CSRF
**Проблема:** SvelteKit по умолчанию включает CSRF защиту, но проксирование через nginx может нарушить проверку origin.

**Рекомендация:**
- Проверить корректность заголовков `Origin` и `Host` в nginx конфигурации
- Настроить `csrf.checkOrigin` в `svelte.config.js`
- Протестировать отправку форм с разных доменов

### 2.3. Отсутствие rate limiting
**Проблема:** PocketBase и фронтенд не имеют ограничений на частоту запросов, что открывает возможность для DoS атак.

**Рекомендация:**
- Настроить rate limiting на уровне nginx
- Включить встроенные ограничения PocketBase (если доступны)
- Добавить капчу для критических операций (регистрация, восстановление пароля)

### 2.4. Хранение токенов Gitea в БД без дополнительного шифрования
**Проблема:** Персональные токены Gitea хранятся в plain text в коллекции `users`.

**Рекомендация:**
- Шифровать токены перед сохранением с использованием `PB_ENCRYPTION_KEY`
- Реализовать механизм обновления токенов
- Добавить опцию "отозвать все токены" в профиле пользователя

---

## 3. Производительность и оптимизация

### 3.1. Отсутствие пагинации для больших списков
**Проблема:** Используется `getFullList()` для загрузки всех записей коллекций, что может привести к проблемам с производительностью при большом количестве данных.

**Рекомендация:**
- Реализовать пагинацию для списков проектов, кейсов, прогонов
- Добавить бесконечную прокрутку или постраничную навигацию
- Использовать `getList()` с limit/offset вместо `getFullList()`

### 3.2. Множественные перезагрузки данных
**Проблема:** После каждого изменения вызывается `invalidateAll()`, что приводит к полной перезагрузке всех данных на странице.

**Рекомендация:**
- Использовать оптимистичные обновления UI
- Реализовать более точечную инвалидацию через `invalidate()`
- Кэшировать данные на клиенте с помощью stores

### 3.3. Отсутствие lazy loading для компонентов
**Проблема:** Все компоненты загружаются в основном бандле.

**Рекомендация:**
- Разделить код на чанки с помощью динамических импортов
- Лениво загружать тяжелые компоненты (редакторы, модалки)
- Использовать `preload` для критических маршрутов

### 3.4. Неоптимальная работа с деревом
**Проблема:** Функция `buildTree` перестраивает дерево при каждом рендере, даже если данные не изменились.

**Рекомендация:**
- Мемоизировать вычисление дерева с помощью `$derived.by()`
- Реализовать инкрементальные обновления дерева
- Добавить виртуализацию для больших деревьев

---

## 4. Качество кода и best practices

### 4.1. Смешение логики и представления
**Проблема:** В компонентах присутствует бизнес-логика, валидация, обработка ошибок.

**Рекомендация:**
- Вынести бизнес-логику в отдельные модули
- Создать хуки/helpers для повторяющихся операций
- Реализовать паттерн "контейнер-презентация" для сложных компонентов

### 4.2. Отсутствие unit-тестов
**Проблема:** В проекте нет тестов, что увеличивает риск регрессий.

**Рекомендация:**
- Настроить Vitest для unit-тестирования
- Начать с тестирования утилитарных функций (`treeUtils.ts`, `utils.ts`)
- Добавить тесты для критических компонентов (редактор кейсов, дерево)

### 4.3. Неполная обработка edge cases
**Проблема:** Не все возможные ошибки обрабатываются (сеть, сервер, невалидные данные).

**Рекомендация:**
- Добавить обработку всех возможных состояний загрузки
- Реализовать retry логику для неудачных запросов
- Добавить fallback UI для ошибок

### 4.4. Отсутствие валидации на клиенте
**Проблема:** Пользователь может ввести некорректные данные, которые будут отправлены на сервер.

**Рекомендация:**
- Добавить валидацию форм с помощью библиотек (Zod, Yup)
- Показывать понятные сообщения об ошибках
- Валидировать данные перед отправкой на сервер

---

## 5. Конфигурация и инфраструктура

### 5.1. Устаревшие зависимости
**Проблема:** Некоторые зависимости могут иметь обновления с исправлениями безопасности.

**Рекомендация:**
- Регулярно обновлять зависимости с помощью `npm audit` и `npm update`
- Использовать Dependabot или аналогичный инструмент
- Закрепить версии только для критических зависимостей

### 5.2. Отсутствие health checks
**Проблема:** Docker контейнеры не имеют health checks, что усложняет мониторинг.

**Рекомендация:**
- Добавить health checks в `docker-compose.yml`
- Настроить мониторинг доступности сервисов
- Реализовать endpoint `/health` для фронтенда и бэкенда

### 5.3. Отсутствие backup стратегии
**Проблема:** Данные PocketBase хранятся в volume без автоматического бэкапа.

**Рекомендация:**
- Настроить регулярное резервное копирование `pb_data`
- Реализовать экспорт данных в JSON/CSV
- Добавить инструкции по восстановлению из бэкапа

### 5.4. Неоптимальная конфигурация nginx
**Проблема:** В nginx конфигурации отсутствуют настройки для сжатия, кэширования и безопасности.

**Рекомендация:**
- Включить gzip сжатие
- Настроить кэширование статических файлов
- Добавить security headers (CSP, HSTS, X-Frame-Options)

---

## 6. Документация и сопровождение

### 6.1. Неполная документация API
**Проблема:** Отсутствует документация по API PocketBase и интеграции с Gitea.

**Рекомендация:**
- Создать OpenAPI спецификацию для кастомных endpoints
- Добавить примеры запросов и ответов
- Документировать процесс настройки интеграций

### 6.2. Отсутствие CONTRIBUTING.md
**Проблема:** Нет руководства для контрибьюторов.

**Рекомендация:**
- Создать `CONTRIBUTING.md` с инструкциями по запуску, тестированию, код-ревью
- Описать процесс коммитов и ветвления
- Добавить шаблон для issue и pull request

### 6.3. Неактуальный CHANGELOG
**Проблема:** В CHANGELOG есть placeholder "123" и неструктурированная информация.

**Рекомендация:**
- Привести CHANGELOG в соответствие с Keep a Changelog
- Регулярно обновлять при каждом релизе
- Использовать семантическое версионирование

---

## 7. UX/UI проблемы

### 7.1. Отсутствие подтверждения для деструктивных действий
**Проблема:** Некоторые операции удаления используют `confirm()`, что не всегда достаточно.

**Рекомендация:**
- Реализовать модальные диалоги с дополнительной информацией
- Добавить возможность отмены в течение короткого времени
- Ввести двухэтапное подтверждение для критических операций

### 7.2. Нет индикации длительных операций
**Проблема:** Пользователь не всегда понимает, что система работает.

**Рекомендация:**
- Добавить глобальный индикатор загрузки
- Показывать прогресс для массовых операций
- Использовать скелетоны вместо спиннеров где возможно

### 7.3. Отсутствие keyboard shortcuts
**Проблема:** Нет поддержки горячих клавиш для частых операций.

**Рекомендация:**
- Добавить shortcuts для сохранения (Ctrl+S), создания нового кейса (Ctrl+N)
- Реализовать навигацию по дереву с клавиатуры
- Сделать shortcuts настраиваемыми

---

## Приоритеты исправления

### Высокий приоритет (критично для безопасности и стабильности):
1. Исправить уязвимые значения в `.env`
2. Добавить CSRF защиту
3. Реализовать типизацию TypeScript
4. Настроить rate limiting

### Средний приоритет (важно для пользовательского опыта):
1. Добавить пагинацию
2. Реализовать централизованную обработку ошибок
3. Улучшить производительность дерева
4. Добавить валидацию форм

### Низкий приоритет (улучшения и оптимизации):
1. Реализовать unit-тесты
2. Добавить keyboard shortcuts
3. Улучшить документацию
4. Оптимизировать конфигурацию nginx

---